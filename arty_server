-- Artillery_Server_Tank_Distance_FIXED.lua
print(">>> SERVER SCRIPT ACTIVE:", game.PlaceId, os.time())
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Debris = game:GetService("Debris")
local Workspace = game:GetService("Workspace")

local remotes = ReplicatedStorage:WaitForChild("Artillery_Remotes")
local FireEvent = remotes:WaitForChild("FireArtillery")
local shellTemplate = ReplicatedStorage:WaitForChild("Artillery_Shell")

local FIRE_SOUND_ID = "rbxassetid://22237162"

-- RANGE & DAMAGE
local MAX_RANGE = 6000
local SPLASH_RADIUS = 28
local MAX_DAMAGE = 175

-- TANK SHELL SETTINGS
local SHELL_SPEED = 1050
local INACCURACY = 2

-- ANTI-SPAM
local COOLDOWN = 0.8
local lastFired = {}

local function isValidGun(model)
	return model
		and model:IsA("Model")
		and model:FindFirstChild("FirePoint", true)
end

local function getSurface(pos)
	local rp = RaycastParams.new()
	rp.FilterType = Enum.RaycastFilterType.Blacklist
	local result = Workspace:Raycast(
		Vector3.new(pos.X, 2000, pos.Z),
		Vector3.new(0, -5000, 0),
		rp
	)
	return result and result.Position or pos
end

local function spawnFlash(fp)
	local flash = Instance.new("Part")
	flash.Shape = Enum.PartType.Ball
	flash.Size = Vector3.new(1.4,1.4,1.4)
	flash.Material = Enum.Material.Neon
	flash.Color = Color3.fromRGB(255,200,50)
	flash.CanCollide = false
	flash.Anchored = true
	flash.Position = fp.Position
	flash.Parent = Workspace
	Debris:AddItem(flash, 0.12)
end

local function explodeAt(position, shell)
	local p = getSurface(position)
	local blast = Instance.new("Part")
	blast.Shape = Enum.PartType.Ball
	blast.Size = Vector3.new(SPLASH_RADIUS*2, SPLASH_RADIUS*2, SPLASH_RADIUS*2)
	blast.Position = p
	blast.Anchored = true
	blast.CanCollide = false
	blast.Material = Enum.Material.Neon
	blast.Color = Color3.fromRGB(255,140,0)
	blast.Transparency = 0.5
	blast.Parent = Workspace
	Debris:AddItem(blast, 0.4)

	local terrain = Workspace:FindFirstChild("Terrain")
	if terrain then
		terrain:FillBall(p - Vector3.new(0,SPLASH_RADIUS*0.2,0), SPLASH_RADIUS*0.6, Enum.Material.Air)
	end

	for _, obj in ipairs(Workspace:GetChildren()) do
		local hum = obj:FindFirstChildWhichIsA("Humanoid")
		local root = obj:FindFirstChild("HumanoidRootPart")
		if hum and root then
			local dist = (root.Position - p).Magnitude
			if dist <= SPLASH_RADIUS then
				local dmg = MAX_DAMAGE * (1 - dist / SPLASH_RADIUS)
				hum:TakeDamage(dmg)
			end
		end
	end

	if shell and shell.Parent then shell:Destroy() end
end

-- firing calc (short for calculator)
FireEvent.OnServerEvent:Connect(function(player, gun, targetPos)
	if typeof(targetPos) ~= "Vector3" then return end
	if not isValidGun(gun) then return end

	local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
	local seat = hum and hum.SeatPart
	if not seat or not seat:IsDescendantOf(gun) then return end

	-- cooldown
	local now = tick()
	if lastFired[gun] and now - lastFired[gun] < COOLDOWN then return end
	lastFired[gun] = now

	local fp = gun:FindFirstChild("FirePoint", true)
	if not fp then return end

	local dist = (targetPos - fp.Position).Magnitude
	if dist > MAX_RANGE then return end

	
	local sound = Instance.new("Sound")
	sound.SoundId = "rbxassetid://222371612"
	sound.Volume = 3
	sound.PlayOnRemove = false
	sound.RollOffMode = Enum.RollOffMode.Linear
	sound.RollOffMinDistance = 20
	sound.RollOffMaxDistance = 550
	sound.Parent = fp

	-- ensure playback
	sound:Play()

	-- delete AFTER playback finishes
	sound.Ended:Connect(function()
		sound:Destroy()
	end)

	-- fallback: destroy after 6 seconds
	Debris:AddItem(sound, 6)


	spawnFlash(fp)

	-- slight random spread
	local angle = math.random() * math.pi * 2
	local radius = math.random() * INACCURACY
	local finalTarget = targetPos + Vector3.new(
		math.cos(angle) * radius,
		0,
		math.sin(angle) * radius
	)

	-- compute ballistic direction
	local startPos = fp.Position + fp.CFrame.LookVector * 4
	local dir = finalTarget - startPos
	local x = Vector3.new(dir.X,0,dir.Z).Magnitude
	local y = dir.Y
	local v = SHELL_SPEED
	local g = Workspace.Gravity

	local fireDir

	local discriminant = v^4 - g * (g*x^2 + 2*y*v*v)
	if discriminant >= 0 then
		local root = math.sqrt(discriminant)
		local theta1 = math.atan((v*v + root)/(g*x))
		local theta2 = math.atan((v*v - root)/(g*x))
		local theta = math.min(theta1, theta2)

		local horizDir = Vector3.new(dir.X,0,dir.Z).Unit

		
		local axis = Vector3.new(-horizDir.Z,0,horizDir.X)
		fireDir = CFrame.fromAxisAngle(axis, theta):VectorToWorldSpace(horizDir)

		fireDir = fireDir.Unit
	else
		fireDir = dir.Unit
	end

	-- spawn shell
	local shell = shellTemplate:Clone()
	local primary = shell:IsA("BasePart") and shell or shell.PrimaryPart
	if not primary then
		for _, d in ipairs(shell:GetDescendants()) do
			if d:IsA("BasePart") then primary = d break end
		end
	end
	if not primary then return end

	primary.CFrame = CFrame.new(startPos)
	shell.Parent = Workspace
	primary.CanCollide = false

	primary.AssemblyLinearVelocity = fireDir * SHELL_SPEED

	local exploded = false
	local function detonate()
		if exploded then return end
		exploded = true
		explodeAt(primary.Position, shell)
	end

	local safeTime = tick() + 0.05
	primary.Touched:Connect(function(hit)
		if tick() < safeTime then return end
		if hit:IsDescendantOf(gun) then return end
		detonate()
	end)

	delay(5, detonate)
end)

print("Tank artillery server (fixed aim) loaded!")
